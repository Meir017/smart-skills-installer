<Project>
  <!-- Register the custom MSBuild tasks -->
  <UsingTask TaskName="SmartSkills.MSBuild.ResolveSmartSkills"
             AssemblyFile="$(MSBuildThisFileDirectory)..\lib\net8.0\SmartSkills.MSBuild.dll" />
  <UsingTask TaskName="SmartSkills.MSBuild.InstallSmartSkills"
             AssemblyFile="$(MSBuildThisFileDirectory)..\lib\net8.0\SmartSkills.MSBuild.dll" />

  <!-- ResolveSmartSkills: runs after NuGet restore resolves packages -->
  <Target Name="ResolveSmartSkills"
          AfterTargets="ResolvePackageAssets"
          BeforeTargets="BeforeCompile"
          Condition="'$(SmartSkillsEnabled)' == 'true' AND '$(SmartSkillsSources)' != '' AND '$(DesignTimeBuild)' != 'true'"
          Inputs="$(ProjectAssetsFile);$(MSBuildProjectFile)"
          Outputs="$(SmartSkillsInstallDir)installed-skills.json">

    <ResolveSmartSkills
      PackageReferences="@(PackageReference)"
      RegistrySources="$(SmartSkillsSources)"
      CacheDirectory="$(SmartSkillsInstallDir)cache\"
      Verbose="$(SmartSkillsVerbose)">
      <Output TaskParameter="ResolvedSkills" ItemName="_SmartSkillsResolved" />
    </ResolveSmartSkills>
  </Target>

  <!-- InstallSmartSkills: runs after resolution -->
  <Target Name="InstallSmartSkills"
          AfterTargets="ResolveSmartSkills"
          Condition="'$(SmartSkillsEnabled)' == 'true' AND '@(_SmartSkillsResolved)' != '' AND '$(DesignTimeBuild)' != 'true'">

    <InstallSmartSkills
      ResolvedSkills="@(_SmartSkillsResolved)"
      InstallDirectory="$(SmartSkillsInstallDir)"
      ForceReinstall="false"
      MaxParallelDownloads="$(SmartSkillsMaxParallelDownloads)">
      <Output TaskParameter="InstalledSkills" ItemName="_SmartSkillsInstalled" />
    </InstallSmartSkills>
  </Target>
</Project>
