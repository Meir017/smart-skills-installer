<Project>
  <!-- Register the custom MSBuild tasks -->
  <UsingTask TaskName="SmartSkills.MSBuild.ResolveSmartSkills"
             AssemblyFile="$(MSBuildThisFileDirectory)..\lib\net10.0\SmartSkills.MSBuild.dll" />
  <UsingTask TaskName="SmartSkills.MSBuild.InstallSmartSkills"
             AssemblyFile="$(MSBuildThisFileDirectory)..\lib\net10.0\SmartSkills.MSBuild.dll" />

  <!--
    SmartSkillsAcquisitionPhase controls when skills are acquired:
      - "build"   (default): runs during Build, after ResolvePackageAssets
      - "restore": runs during Restore, after CollectPackageReferences

    Multi-targeting: When a project targets multiple frameworks (TargetFrameworks),
    MSBuild outer build dispatches to inner builds per TFM. We only run once using
    the first TFM (_SmartSkillsRunTFM) to avoid redundant work.
  -->

  <!-- Determine if this is the TFM that should run SmartSkills tasks -->
  <PropertyGroup Condition="'$(TargetFrameworks)' != ''">
    <_SmartSkillsFirstTFM>$([System.String]::Copy('$(TargetFrameworks)').Split(';')[0])</_SmartSkillsFirstTFM>
    <_SmartSkillsShouldRun Condition="'$(TargetFramework)' == '$(_SmartSkillsFirstTFM)'">true</_SmartSkillsShouldRun>
    <_SmartSkillsShouldRun Condition="'$(TargetFramework)' != '$(_SmartSkillsFirstTFM)'">false</_SmartSkillsShouldRun>
  </PropertyGroup>
  <PropertyGroup Condition="'$(TargetFrameworks)' == ''">
    <_SmartSkillsShouldRun>true</_SmartSkillsShouldRun>
  </PropertyGroup>

  <!-- BUILD-TIME acquisition (default) -->
  <Target Name="ResolveSmartSkills"
          AfterTargets="ResolvePackageAssets"
          BeforeTargets="BeforeCompile"
          Condition="'$(SmartSkillsEnabled)' == 'true'
                     AND '$(SmartSkillsSources)' != ''
                     AND '$(DesignTimeBuild)' != 'true'
                     AND '$(SmartSkillsAcquisitionPhase)' != 'restore'
                     AND '$(_SmartSkillsShouldRun)' == 'true'"
          Inputs="$(ProjectAssetsFile);$(MSBuildProjectFile)"
          Outputs="$(SmartSkillsInstallDir)installed-skills.json">

    <ResolveSmartSkills
      PackageReferences="@(PackageReference)"
      RegistrySources="$(SmartSkillsSources)"
      CacheDirectory="$(SmartSkillsInstallDir)cache\"
      Verbose="$(SmartSkillsVerbose)">
      <Output TaskParameter="ResolvedSkills" ItemName="_SmartSkillsResolved" />
    </ResolveSmartSkills>
  </Target>

  <!-- RESTORE-TIME acquisition (opt-in) -->
  <Target Name="ResolveSmartSkillsOnRestore"
          AfterTargets="CollectPackageReferences"
          Condition="'$(SmartSkillsEnabled)' == 'true'
                     AND '$(SmartSkillsSources)' != ''
                     AND '$(SmartSkillsAcquisitionPhase)' == 'restore'
                     AND '$(_SmartSkillsShouldRun)' == 'true'"
          Inputs="$(MSBuildProjectFile)"
          Outputs="$(SmartSkillsInstallDir)installed-skills.json">

    <ResolveSmartSkills
      PackageReferences="@(PackageReference)"
      RegistrySources="$(SmartSkillsSources)"
      CacheDirectory="$(SmartSkillsInstallDir)cache\"
      Verbose="$(SmartSkillsVerbose)">
      <Output TaskParameter="ResolvedSkills" ItemName="_SmartSkillsResolved" />
    </ResolveSmartSkills>
  </Target>

  <!-- InstallSmartSkills: runs after resolution (either phase) -->
  <Target Name="InstallSmartSkills"
          AfterTargets="ResolveSmartSkills;ResolveSmartSkillsOnRestore"
          Condition="'$(SmartSkillsEnabled)' == 'true'
                     AND '@(_SmartSkillsResolved)' != ''
                     AND '$(DesignTimeBuild)' != 'true'
                     AND '$(_SmartSkillsShouldRun)' == 'true'">

    <InstallSmartSkills
      ResolvedSkills="@(_SmartSkillsResolved)"
      InstallDirectory="$(SmartSkillsInstallDir)"
      ForceReinstall="false"
      MaxParallelDownloads="$(SmartSkillsMaxParallelDownloads)">
      <Output TaskParameter="InstalledSkills" ItemName="_SmartSkillsInstalled" />
    </InstallSmartSkills>
  </Target>
</Project>
